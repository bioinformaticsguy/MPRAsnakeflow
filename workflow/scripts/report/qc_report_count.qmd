---
title: "QC Measures"
page-layout: full
format:
  html:
    code-fold: true
    code-tools: true
    embed-resources: true
    anchor-sections: true
    smooth-scroll: true
    toc: true
theme:
  light: flatly
  dark: darkly
jupyter: python3

---


```{python}
#| echo: false
# Imports
from IPython.display import display, Image, Markdown
import pandas as pd
```

```{python}
#| tags: [parameters]
#| echo: false
```


```{python}
#| echo: false
oligo_cor_merged_table = pd.read_csv(f"{workdir}/{statistics_all_oligo_cor_merged}", sep='\t')
oligo_cor_merged_table_thresh = oligo_cor_merged_table[oligo_cor_merged_table[oligo_cor_merged_table.columns[-1]] == True]
oligo_cor_merged_table_all = oligo_cor_merged_table[oligo_cor_merged_table[oligo_cor_merged_table.columns[-1]] == False]

dna_spear = oligo_cor_merged_table_thresh['DNA_spearman'].min()
rna_spear = oligo_cor_merged_table_thresh['RNA_spearman'].min()
ratio_spear = oligo_cor_merged_table_thresh['Ratio_spearman'].min()
```

```{python}
#| echo: false

threshold_dna_spear = 0.85
threshold_rna_spear = 0.95
threshold_ratio_spear = 0.75

important = dna_spear < threshold_dna_spear and rna_spear < threshold_rna_spear and ratio_spear < threshold_ratio_spear
warning = dna_spear < threshold_dna_spear or rna_spear < threshold_rna_spear or ratio_spear < threshold_ratio_spear

if important:
    display(Markdown(f'''
::: {"{.callout-important}"}

## Low correlation!

Spearman correlation across replicates is low using a barcode threshold per oligo of {thresh}! Spearman correlation of DNA is {dna_spear:.2f}, RNA is {rna_spear:.2f} and DNA/RNA ratio is {ratio_spear:.2f}. Minimum allowed varues are {threshold_dna_spear:.2f}, {threshold_rna_spear:.2f}, and {threshold_ratio_spear:.2f}.

:::
'''))
elif warning:
    display(Markdown(f'''
::: {"{.callout-warning}"}

## Low correlation warning!

At least one (not all) Spearman correlations across replicates is low using a barcode threshold per oligo of {thresh}! Spearman correlation of DNA is {dna_spear:.2f}, RNA is {rna_spear:.2f} and DNA/RNA ratio is {ratio_spear:.2f}. Minimum allowed varues are {threshold_dna_spear:.2f}, {threshold_rna_spear:.2f}, and {threshold_ratio_spear:.2f}.

:::
'''))
else:
    display(Markdown(f'''
::: {"{.callout-tip}"}

## Good Spearman correlation across replicates!

The data has a good Spearman correlations across replicates using a barcode threshold per oligo of {thresh}! Spearman correlation of DNA is {dna_spear:.2f}, RNA is {rna_spear:.2f} and DNA/RNA ratio is {ratio_spear:.2f}.

:::
'''))

```


# Oligo Coorelatioin

Oligo correlation plots of DNA, RNA and DNA/RNA ratios across replicates. First tab shows plots using (in average) `{python} "%d" % oligo_cor_merged_table_thresh['number_Oligos_Joined'].mean()` oligos with a minimum number of  `{python} thresh` barcodes. Second tab shows all `{python} "%d" % oligo_cor_merged_table_all['number_Oligos_Joined'].mean()` oligos that have assigned barcodes.

::: {.panel-tabset}

## Threshold `{python} thresh`

::: {.panel-tabset}

### DNA
```{python}
#| echo: false
display(Image(f"{workdir}/{dna_oligo_coor_min_thre_plot }"))
```

### RNA
```{python}
#| echo: false
display(Image(f"{workdir}/{rna_oligo_coor_min_thre_plot}"))
```

### Ratio
```{python}
#| echo: false
display(Image(f"{workdir}/{ratio_oligo_min_thre_plot}"))
```

:::


## All

::: {.panel-tabset}

### DNA
```{python}
#| echo: false
display(Image(f"{workdir}/{dna_oligo_coor_plot}"))
```

### RNA
```{python}
#| echo: false
display(Image(f"{workdir}/{rna_oligo_coor_plot}"))
```

### Ratio
```{python}
#| echo: false
display(Image(f"{workdir}/{ratio_oligo_coor_plot}"))
```

:::

:::

# Activity

Violin and box plots of the log2 fold change of all oligos by the assay. Grouped by labels if set, otherwise `NA`. First tab shows plots using (in average) `{python} "%d" % oligo_cor_merged_table_thresh['number_Oligos_Joined'].mean()` oligos with a minimum number of  `{python} thresh` barcodes. Second tab shows all `{python} "%d" % oligo_cor_merged_table_all['number_Oligos_Joined'].mean()` oligos that have assigned barcodes.

::: {.panel-tabset}

## Threshold `{python} thresh`
```{python}
#| echo: false
display(Image(f"{workdir}/{activity_thresh}"))
```

## All
```{python}
#| echo: false
display(Image(f"{workdir}/{activity_all}"))
```

:::

# Number of barcodes per oligo

Histogramm of number of barcodes per oligo. Median is blue, mean is red.

::: {.panel-tabset}
# DNA
```{python}
#| echo: false
display(Image(f"{workdir}/{counts_per_oligo_dna}")) 
```

# RNA
```{python}
#| echo: false
display(Image(f"{workdir}/{counts_per_oligo_rna}")) 
```

:::

# Oligo Correlation Table
```{python}
#| echo: false

pd_merged = pd.read_csv(f"{workdir}/{statistics_all_merged}", sep='\t').round(2)
n_oligos = str(pd_merged['oligos design'].iloc[0])
```


The total number of oligos in this experiment is `{python} n_oligos`.

::: {.panel-tabset}

# Merged
```{python}
#| echo: false
pd_merged.drop(columns=['oligos design'], inplace=True)
pd_merged
```

# Single
```{python}
#| echo: false
pd.read_csv(f"{workdir}/{statistics_all_single}", sep='\t').round(2)
```

:::

# Statistics between replicates

```{python}
#| echo: false

def filter_table(df):
    df = df.round(2).drop(columns=['DNA_pearson','RNA_pearson', 'Ratio_pearson'])
    df = df.drop(df.columns[-1], axis=1)
    return(df)
```



::: {.panel-tabset}

## Threshold `{python} thresh`
```{python}
#| echo: false
oligo_cor_merged_table_thresh = filter_table(oligo_cor_merged_table_thresh)
oligo_cor_merged_table_thresh
```

## All
```{python}
#| echo: false
oligo_cor_merged_table_all = filter_table(oligo_cor_merged_table_all)
oligo_cor_merged_table_all
```

:::
